<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layla's Homeschool Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Comic Neue', cursive; background-color: #FFFBEB; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        .focus-ring:focus { outline: none; box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.7); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { animation: slideIn 0.3s; width: 95%; max-width: 800px; max-height: 90vh; }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { translateY(0); opacity: 1; } }
        .unit-item { transition: all 0.2s; }
        .unit-item.completed { background-color: #D1FAE5; border-color: #10B981; }
        .unit-item.locked { background-color: #F3F4F6; color: #9CA3AF; cursor: not-allowed; }
        .draggable { cursor: grab; touch-action: none; }
        .drop-zone { border: 4px dashed #ccc; transition: background-color 0.3s, border-color 0.3s; }
        .drop-zone.over { background-color: #e0f2fe; border-color: #38bdf8; }
        [hidden] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="auth-status" class="bg-indigo-600 text-white p-2 text-center text-sm sm:text-lg">Loading...</div>
    
    <main class="container mx-auto p-4 sm:p-6">
        <!-- Grade Selection Screen -->
        <div id="grade-selection-screen">
            <header class="text-center mb-8">
                <h1 class="text-4xl sm:text-5xl font-bold text-sky-600">Layla's Learning Hub</h1>
                <p class="text-lg sm:text-xl mt-2 text-gray-600">Select a Grade to Begin!</p>
            </header>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 max-w-2xl mx-auto">
                <button id="grade-1-btn" class="grade-btn bg-green-500 text-white p-8 rounded-2xl shadow-lg hover:bg-green-600 transition-transform hover:scale-105 focus-ring">
                    <span class="text-4xl font-bold">1st Grade</span>
                </button>
                <button id="grade-2-btn" class="grade-btn bg-gray-400 text-white p-8 rounded-2xl shadow-lg cursor-not-allowed focus-ring" disabled>
                    <span class="text-4xl font-bold">2nd Grade</span>
                    <span id="grade-2-lock" class="block text-sm mt-1">üîí Complete 1st Grade to Unlock</span>
                </button>
            </div>
        </div>

        <!-- Subject/Unit Screen -->
        <div id="subject-screen" hidden>
            <header class="flex items-center justify-between mb-6">
                <button id="back-to-grades" class="bg-white p-3 rounded-full shadow hover:bg-gray-200 focus-ring">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h1 id="subject-header" class="text-3xl sm:text-4xl font-bold text-center text-sky-600"></h1>
                <div class="w-12"></div> <!-- Spacer -->
            </header>
            <div id="subject-tabs" class="flex justify-center flex-wrap gap-2 mb-6"></div>
            <div id="unit-container" class="space-y-4"></div>
        </div>
    </main>

    <!-- The Modal for Lessons, Games, etc. -->
    <div id="activity-modal" class="modal items-center justify-center p-2"><div class="modal-content bg-white p-4 sm:p-6 rounded-2xl shadow-xl relative flex flex-col"><button id="close-modal" class="absolute top-2 right-3 text-3xl sm:text-4xl font-bold text-gray-400 hover:text-gray-600 transition">&times;</button><div id="modal-body" class="flex-grow overflow-y-auto"></div></div></div>
    
    <footer class="text-center p-4 mt-4">
        <a href="./parent-dashboard.html" class="text-sm text-gray-500 hover:text-indigo-600 transition">Parent Dashboard</a>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { curriculumData } from './curriculum.js';

        let db, auth, userId, appId, currentGrade, currentSubject;
        let progressData = {};

        const firebaseConfig = { apiKey: "AIzaSyAfatIGx88HP1fH0_EGTr_zHpvNa1Rcg7k", authDomain: "laylahomeschool-77ac4.firebaseapp.com", projectId: "laylahomeschool-77ac4", storageBucket: "laylahomeschool-77ac4.firebasestorage.app", messagingSenderId: "491842629315", appId: "1:491842629315:web:8644c66d1cde1b734fbc76" };
        appId = "laylahomeschool-77ac4";

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('auth-status').innerHTML = `<p>Welcome Layla! | Tracking ID: <span class="font-mono">${userId.substring(0,8)}</span></p>`;
                    listenForProgress();
                } else {
                    signInAnonymously(auth);
                }
            });
        } catch (e) {
            document.getElementById('auth-status').innerText = "Connection Error.";
            console.error("Firebase init failed:", e);
        }

        function listenForProgress() {
            const progressRef = doc(db, `artifacts/${appId}/users/${userId}`);
            onSnapshot(progressRef, (docSnap) => {
                if (docSnap.exists()) {
                    progressData = docSnap.data();
                }
                checkGradeCompletion();
                if (currentGrade && currentSubject) {
                    renderUnits(currentGrade, currentSubject);
                }
            });
        }
        
        function checkGradeCompletion() {
            const grade1Mastery = curriculumData[1] && Object.keys(curriculumData[1]).every(subject => {
                const units = curriculumData[1][subject].units;
                return units.every(unit => unit.items.every(item => progressData[item.id]?.completed));
            });
            
            const grade2Btn = document.getElementById('grade-2-btn');
            const grade2Lock = document.getElementById('grade-2-lock');
            if (grade1Mastery) {
                grade2Btn.disabled = false;
                grade2Btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                grade2Btn.classList.add('bg-purple-500', 'hover:bg-purple-600');
                grade2Lock.hidden = true;
            }
        }
        
        async function saveProgress(itemId, data) {
            if (!userId) return;
            const progressRef = doc(db, `artifacts/${appId}/users/${userId}`);
            await setDoc(progressRef, { [itemId]: data }, { merge: true });
        }
        
        function showScreen(screenId) {
            document.getElementById('grade-selection-screen').hidden = screenId !== 'grade';
            document.getElementById('subject-screen').hidden = screenId !== 'subject';
        }

        function renderSubjects(grade) {
            currentGrade = grade;
            showScreen('subject');
            document.getElementById('subject-header').textContent = `${grade}${grade === 1 ? 'st' : 'nd'} Grade`;
            const tabsContainer = document.getElementById('subject-tabs');
            tabsContainer.innerHTML = Object.keys(curriculumData[grade]).map(subjectKey => 
                `<button data-subject="${subjectKey}" class="subject-tab-btn capitalize p-3 px-5 rounded-full text-lg font-semibold bg-white shadow">${subjectKey}</button>`
            ).join('');
            
            const firstSubject = Object.keys(curriculumData[grade])[0];
            renderUnits(grade, firstSubject);
            tabsContainer.querySelector(`[data-subject="${firstSubject}"]`).classList.add('bg-sky-500', 'text-white');
        }

        function renderUnits(grade, subjectKey) {
            currentSubject = subjectKey;
            document.querySelectorAll('.subject-tab-btn').forEach(btn => {
                btn.classList.toggle('bg-sky-500', btn.dataset.subject === subjectKey);
                btn.classList.toggle('text-white', btn.dataset.subject === subjectKey);
            });
            
            const unitContainer = document.getElementById('unit-container');
            const subject = curriculumData[grade][subjectKey];
            unitContainer.innerHTML = subject.units.map((unit, unitIndex) => `
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-2xl font-bold mb-3 text-gray-700">${unit.title}</h3>
                    <div class="space-y-2">${unit.items.map((item, itemIndex) => {
                        const isCompleted = progressData[item.id]?.completed;
                        const isLocked = unitIndex > 0 && !unit.items.slice(0, itemIndex).every(i => progressData[i.id]?.completed); // Simple sequential lock for now
                        const icon = { lesson: 'üìñ', game: 'üéÆ', activity: 'üé®', video: 'üé¨', quiz: 'üìù', test: 'üèÜ' }[item.type];
                        return `<button data-item-id="${item.id}" ${isLocked ? 'disabled' : ''} class="unit-item w-full text-left flex items-center p-4 border-2 rounded-lg ${isCompleted ? 'completed' : ''} ${isLocked ? 'locked' : 'hover:bg-sky-100'}">
                            <span class="text-2xl mr-4">${icon}</span>
                            <span class="flex-grow font-semibold text-lg">${item.title}</span>
                            ${isCompleted ? '<span class="text-2xl text-green-600">‚úî</span>' : ''}
                        </button>`;
                    }).join('')}</div>
                </div>
            `).join('');
        }
        
        function openActivityModal(itemId) {
            const [grade, subject, unitIndex, itemIndex] = itemId.split('-');
            const item = curriculumData[grade][subject].units[unitIndex].items[itemIndex];
            const modalBody = document.getElementById('modal-body');
            
            let content = `<h2 class="text-2xl sm:text-3xl font-bold text-center mb-4">${item.title}</h2>`;
            
            switch (item.type) {
                case 'lesson':
                    content += `<div class="prose max-w-none text-lg p-2">${item.content}</div>`;
                    saveProgress(itemId, { completed: true }); // Auto-complete lesson on view
                    break;
                case 'video':
                    content += `<p class="text-center text-gray-600 mb-4">${item.description}</p>
                    <div class="aspect-w-16 aspect-h-9"><iframe src="https://www.youtube.com/embed/${item.videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full rounded-lg"></iframe></div>`;
                    saveProgress(itemId, { completed: true });
                    break;
                case 'quiz':
                case 'test':
                    content += `<div id="quiz-container" class="space-y-4"></div>`;
                    setTimeout(() => renderQuiz(item), 0);
                    break;
                // Add game rendering here in the future
            }
            modalBody.innerHTML = content;
            document.getElementById('activity-modal').style.display = 'flex';
        }

        function renderQuiz(item) {
            const container = document.getElementById('quiz-container');
            let quizHtml = '';
            item.questions.forEach((q, index) => {
                quizHtml += `<div class="bg-gray-50 p-4 rounded-lg">
                    <p class="font-bold text-lg mb-2">${index + 1}. ${q.q}</p>
                    <div class="space-y-2">${q.options.map(opt => `
                        <label class="flex items-center p-3 rounded-lg hover:bg-gray-200 cursor-pointer">
                            <input type="radio" name="q${index}" value="${opt}" class="h-5 w-5 mr-3">
                            <span>${opt}</span>
                        </label>`).join('')}
                    </div>
                </div>`;
            });
            quizHtml += `<div class="text-center mt-6"><button id="submit-quiz-btn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-lg text-xl hover:bg-green-600">Submit Answers</button></div>`;
            container.innerHTML = quizHtml;
            
            document.getElementById('submit-quiz-btn').onclick = () => {
                let score = 0;
                item.questions.forEach((q, index) => {
                    const selected = document.querySelector(`input[name="q${index}"]:checked`);
                    if (selected && selected.value === q.a) {
                        score++;
                    }
                });
                const total = item.questions.length;
                const passed = (score / total) >= 0.7;
                saveProgress(item.id, { completed: passed, score, total });
                container.innerHTML = `<div class="text-center p-8">
                    <h3 class="text-3xl font-bold">Quiz Complete!</h3>
                    <p class="text-5xl my-4">${Math.round((score/total)*100)}%</p>
                    <p class="text-2xl">${score} / ${total} Correct</p>
                    ${passed ? '<p class="text-green-600 font-bold mt-4 text-xl">Great job, you passed!</p>' : '<p class="text-red-600 font-bold mt-4 text-xl">Let\'s review and try again!</p>'}
                    <button onclick="document.getElementById('close-modal').click()" class="mt-6 bg-sky-500 text-white font-bold py-3 px-8 rounded-lg text-xl hover:bg-sky-600">Continue</button>
                </div>`;
            };
        }

        // --- Event Listeners ---
        document.getElementById('grade-1-btn').addEventListener('click', () => renderSubjects(1));
        document.getElementById('grade-2-btn').addEventListener('click', () => renderSubjects(2));
        document.getElementById('back-to-grades').addEventListener('click', () => showScreen('grade'));
        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('activity-modal').style.display = 'none';
            document.getElementById('modal-body').innerHTML = '';
        });
        document.addEventListener('click', e => {
            if (e.target.closest('.subject-tab-btn')) {
                renderUnits(currentGrade, e.target.closest('.subject-tab-btn').dataset.subject);
            }
            if (e.target.closest('.unit-item')) {
                openActivityModal(e.target.closest('.unit-item').dataset.itemId);
            }
        });

        // Initial setup
        showScreen('grade');
    </script>
</body>
</html>


